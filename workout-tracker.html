<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workout Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #ffffff;
        color: #000000;
        line-height: 1.5;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
      }

      .header {
        background: #000000;
        color: #ffffff;
        padding: 20px 16px;
        border-bottom: 1px solid #000000;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
      }

      .header-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-icon {
        background: #ffffff;
        color: #000000;
        border: 1px solid #ffffff;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }

      .btn-icon:active {
        background: #f5f5f5;
      }

      body.light-theme {
        background: #000000;
        color: #ffffff;
      }

      body.light-theme .header {
        background: #ffffff;
        color: #000000;
        border-bottom: 1px solid #ffffff;
      }

      body.light-theme .btn-icon {
        background: #000000;
        color: #ffffff;
        border: 1px solid #000000;
      }

      body.light-theme .btn-icon:active {
        background: #333333;
      }

      body.light-theme .btn {
        background: #ffffff;
        color: #000000;
        border: 1px solid #ffffff;
      }

      body.light-theme .btn:active {
        background: #f5f5f5;
      }

      body.light-theme .btn-secondary {
        background: #000000;
        color: #ffffff;
        border: 1px solid #ffffff;
      }

      body.light-theme .btn-secondary:active {
        background: #333333;
      }

      body.light-theme .btn-danger {
        background: #000000;
        color: #ffffff;
        border: 1px solid #ffffff;
      }

      body.light-theme .tabs {
        border-bottom: 1px solid #ffffff;
      }

      body.light-theme .tab {
        color: #999999;
      }

      body.light-theme .tab.active {
        border-bottom-color: #ffffff;
        color: #ffffff;
      }

      body.light-theme .workout-card {
        background: #000000;
        border: 1px solid #ffffff;
      }

      body.light-theme .workout-card:active {
        background: #333333;
      }

      body.light-theme .workout-card p {
        color: #999999;
      }

      body.light-theme .modal-content {
        background: #000000;
      }

      body.light-theme .modal-header {
        background: #ffffff;
        color: #000000;
        border-bottom: 1px solid #ffffff;
      }

      body.light-theme .close-btn {
        color: #000000;
      }

      body.light-theme .form-group input,
      body.light-theme .form-group select {
        border: 1px solid #ffffff;
        background: #000000;
        color: #ffffff;
      }

      body.light-theme .form-group input:focus,
      body.light-theme .form-group select:focus {
        outline: 2px solid #ffffff;
      }

      body.light-theme .exercise-item {
        border: 1px solid #ffffff;
      }

      body.light-theme .exercise-header input {
        border-bottom: 1px solid #ffffff;
        color: #ffffff;
      }

      body.light-theme .exercise-header input:focus {
        border-bottom: 2px solid #ffffff;
      }

      body.light-theme .set-labels {
        color: #999999;
      }

      body.light-theme .set-row input,
      body.light-theme .set-row select {
        border: 1px solid #ffffff;
        background: #000000;
        color: #ffffff;
      }

      body.light-theme .empty-state {
        color: #999999;
      }

      body.light-theme .empty-state h3 {
        color: #ffffff;
      }

      body.light-theme .preset-exercise-item {
        border: 1px solid #ffffff;
        background: #000000;
      }

      body.light-theme .preset-exercise-item input {
        border-bottom: 1px solid #ffffff;
        color: #ffffff;
      }

      body.light-theme .preset-exercise-item input:focus {
        border-bottom: 2px solid #ffffff;
      }

      body.light-theme .confirm-content {
        background: #000000;
        border: 1px solid #ffffff;
      }

      body.light-theme .confirm-content p {
        color: #999999;
      }

      body.light-theme #timerDisplay {
        color: #ffffff;
      }

      body.light-theme #customTime {
        border: 1px solid #ffffff;
        background: #000000;
        color: #ffffff;
      }

      body.light-theme #customTime:focus {
        outline: 2px solid #ffffff;
      }

      body.light-theme .exercise-checkbox-item {
        border: 1px solid #ffffff;
      }

      body.light-theme .exercise-checkbox-item:hover {
        background: #333333;
      }

      body.light-theme
        .exercise-checkbox-item
        input[type="checkbox"]:checked
        + label {
        color: #ffffff;
      }

      .file-input {
        display: none;
      }

      .main-content {
        padding: 16px;
      }

      .btn {
        background: #000000;
        color: #ffffff;
        border: 1px solid #000000;
        padding: 12px 20px;
        border-radius: 0;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        width: 100%;
        text-align: center;
        transition: background 0.2s;
      }

      .btn:active {
        background: #333333;
      }

      .btn-secondary {
        background: #ffffff;
        color: #000000;
        border: 1px solid #000000;
      }

      .btn-secondary:active {
        background: #f5f5f5;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 13px;
        width: auto;
      }

      .btn-danger {
        background: #ffffff;
        color: #000000;
        border: 1px solid #000000;
      }

      .tabs {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        border-bottom: 1px solid #000000;
      }

      .tab {
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        padding: 12px 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666666;
      }

      .tab.active {
        border-bottom-color: #000000;
        color: #000000;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .workout-list {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .workout-card {
        background: #ffffff;
        border: 1px solid #000000;
        padding: 16px;
        cursor: pointer;
      }

      .workout-card:active {
        background: #f5f5f5;
      }

      .workout-card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .workout-card p {
        font-size: 14px;
        color: #666666;
        margin-bottom: 4px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
      }

      .modal.active {
        display: block;
      }

      .modal-content {
        background: #ffffff;
        min-height: 100vh;
        width: 100%;
      }

      .modal-header {
        background: #000000;
        color: #ffffff;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #000000;
      }

      .modal-header h2 {
        font-size: 20px;
        font-weight: 600;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #ffffff;
        line-height: 1;
        padding: 0;
      }

      .modal-body {
        padding: 16px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #000000;
        border-radius: 0;
        font-size: 16px;
        background: #ffffff;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: 2px solid #000000;
        outline-offset: -2px;
      }

      .exercise-list {
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .exercise-item {
        border: 1px solid #000000;
        padding: 16px;
        margin-bottom: 16px;
      }

      .exercise-header {
        margin-bottom: 16px;
      }

      .exercise-header input {
        width: 100%;
        border: none;
        border-bottom: 1px solid #000000;
        padding: 8px 0;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .exercise-header input:focus {
        outline: none;
        border-bottom: 2px solid #000000;
      }

      .sets-container {
        margin-top: 16px;
      }

      .set-labels {
        display: grid;
        grid-template-columns: 50px 1fr 80px 60px;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #666666;
      }

      .set-row {
        display: grid;
        grid-template-columns: 50px 1fr 80px 60px;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      .set-row input,
      .set-row select {
        padding: 8px;
        border: 1px solid #000000;
        border-radius: 0;
        font-size: 14px;
      }

      .set-number {
        font-weight: 600;
        font-size: 14px;
      }

      .button-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        padding-bottom: 20px;
      }

      .button-row {
        display: flex;
        gap: 8px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666666;
      }

      .empty-state h3 {
        margin-bottom: 8px;
        color: #000000;
        font-size: 18px;
      }

      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        margin-top: 24px;
      }

      .preset-exercise-item {
        border: 1px solid #000000;
        padding: 16px;
        margin-bottom: 12px;
        background: #ffffff;
      }

      .preset-exercise-item input {
        width: 100%;
        border: none;
        border-bottom: 1px solid #000000;
        padding: 8px 0;
        font-size: 16px;
        font-weight: 600;
        background: transparent;
        color: #000000;
      }

      .preset-exercise-item input:focus {
        outline: none;
        border-bottom: 2px solid #000000;
      }

      .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .confirm-modal.active {
        display: flex;
      }

      .confirm-content {
        background: #ffffff;
        border: 1px solid #000000;
        padding: 24px;
        max-width: 400px;
        width: 100%;
      }

      .confirm-content h3 {
        margin-bottom: 16px;
        font-size: 18px;
      }

      .confirm-content p {
        margin-bottom: 24px;
        color: #666666;
      }

      .confirm-buttons {
        display: flex;
        gap: 12px;
      }

      .exercise-checkbox-item {
        border: 1px solid #000000;
        padding: 12px 16px;
        margin-bottom: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #ffffff;
      }

      .exercise-checkbox-item:hover {
        background: #f5f5f5;
      }

      .exercise-checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .exercise-checkbox-item label {
        flex: 1;
        cursor: pointer;
        font-weight: 500;
      }

      .exercise-checkbox-item input[type="checkbox"]:checked + label {
        color: #000000;
      }

      .textarea-group {
        margin-bottom: 20px;
      }

      .textarea-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
      }

      .textarea-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #000000;
        border-radius: 0;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        background: #ffffff;
      }

      .textarea-group textarea:focus {
        outline: 2px solid #000000;
        outline-offset: -2px;
      }

      body.light-theme .textarea-group textarea {
        border: 1px solid #ffffff;
        background: #000000;
        color: #ffffff;
      }

      body.light-theme .textarea-group textarea:focus {
        outline: 2px solid #ffffff;
      }

      .exercise-notes {
        font-size: 13px;
        color: #999999;
        margin-top: 4px;
        font-style: italic;
      }

      @media (min-width: 768px) {
        .container {
          max-width: 800px;
        }

        .modal-content {
          margin: 40px auto;
          max-width: 800px;
          min-height: auto;
          border: 1px solid #000000;
        }

        body.light-theme .modal-content {
          border: 1px solid #ffffff;
        }

        .workout-list {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
        }

        .button-group {
          flex-direction: row;
        }

        .btn {
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Workout Tracker</h1>
          <div class="header-buttons">
            <button class="btn-icon" onclick="toggleTheme()">Theme</button>
            <button class="btn-icon" onclick="exportData()">Export</button>
            <button
              class="btn-icon"
              onclick="document.getElementById('importFile').click()"
            >
              Import
            </button>
            <input
              type="file"
              id="importFile"
              class="file-input"
              accept=".json"
              onchange="importData(event)"
            />
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('presets')">
            Presets
          </button>
          <button class="tab" onclick="switchTab('workouts')">Workouts</button>
          <button class="tab" onclick="switchTab('library')">Library</button>
          <button class="tab" onclick="switchTab('timer')">Timer</button>
        </div>

        <div id="presetsTab" class="tab-content active">
          <button
            class="btn"
            style="margin-top: 16px"
            onclick="showCreatePresetModal()"
          >
            New Preset
          </button>
          <div id="presetList" class="workout-list"></div>
        </div>

        <div id="workoutsTab" class="tab-content">
          <button
            class="btn"
            style="margin-top: 16px"
            onclick="showTrackWorkoutModal()"
          >
            Track Workout
          </button>
          <div id="workoutList" class="workout-list"></div>
        </div>

        <div id="libraryTab" class="tab-content">
          <button
            class="btn"
            style="margin-top: 16px"
            onclick="showCreateExerciseModal()"
          >
            New Exercise
          </button>
          <div id="libraryList" class="workout-list"></div>
        </div>

        <div id="timerTab" class="tab-content">
          <div style="text-align: center; padding: 40px 20px">
            <div
              style="font-size: 72px; font-weight: 600; margin-bottom: 40px"
              id="timerDisplay"
            >
              0:00
            </div>

            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-bottom: 24px;
                flex-wrap: wrap;
              "
            >
              <button class="btn btn-small" onclick="setTimer(30)">30s</button>
              <button class="btn btn-small" onclick="setTimer(60)">1m</button>
              <button class="btn btn-small" onclick="setTimer(90)">
                1m 30s
              </button>
              <button class="btn btn-small" onclick="setTimer(120)">2m</button>
              <button class="btn btn-small" onclick="setTimer(180)">3m</button>
            </div>

            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-bottom: 24px;
              "
            >
              <button class="btn" onclick="startTimer()" id="startBtn">
                Start
              </button>
              <button
                class="btn btn-secondary"
                onclick="pauseTimer()"
                id="pauseBtn"
                style="display: none"
              >
                Pause
              </button>
              <button class="btn btn-secondary" onclick="resetTimer()">
                Reset
              </button>
            </div>

            <div style="margin-top: 40px">
              <label
                style="display: block; margin-bottom: 12px; font-weight: 500"
                >Custom Time (seconds)</label
              >
              <input
                type="number"
                id="customTime"
                placeholder="90"
                min="1"
                style="
                  width: 200px;
                  padding: 12px;
                  border: 1px solid #000000;
                  font-size: 16px;
                  text-align: center;
                "
              />
              <button
                class="btn btn-small"
                onclick="setCustomTimer()"
                style="margin-top: 12px"
              >
                Set
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preset Modal -->
    <div id="presetModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="presetModalTitle">New Preset</h2>
          <button class="close-btn" onclick="closePresetModal()">
            &times;
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Preset Name</label>
            <input type="text" id="presetName" placeholder="Upper Body Day" />
          </div>

          <h3 class="section-title">Select Exercises</h3>
          <div id="presetExercisesList" class="exercise-list"></div>

          <div class="button-group">
            <button class="btn" onclick="savePreset()">Save Preset</button>
            <button class="btn btn-secondary" onclick="closePresetModal()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Exercise Modal -->
    <div id="exerciseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="exerciseModalTitle">New Exercise</h2>
          <button class="close-btn" onclick="closeExerciseModal()">
            &times;
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Exercise Name</label>
            <input type="text" id="exerciseName" placeholder="Bench Press" />
          </div>

          <div class="textarea-group">
            <label>Notes (Optional)</label>
            <textarea
              id="exerciseNotes"
              placeholder="Add any notes about this exercise..."
            ></textarea>
          </div>

          <div class="button-group">
            <button class="btn" onclick="saveExercise()">Save Exercise</button>
            <button class="btn btn-secondary" onclick="closeExerciseModal()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Track Workout Modal -->
    <div id="workoutModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="workoutModalTitle">Track Workout</h2>
          <button class="close-btn" onclick="closeWorkoutModal()">
            &times;
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Select Preset</label>
            <select id="workoutPreset" onchange="loadPresetExercises()">
              <option value="">Choose a preset</option>
            </select>
          </div>

          <div class="form-group">
            <label>Date</label>
            <input type="date" id="workoutDate" />
          </div>

          <h3 class="section-title">Exercises</h3>
          <div id="exercisesList" class="exercise-list"></div>

          <h3 class="section-title">Cardio (Optional)</h3>
          <div class="form-group">
            <label>Cardio Type</label>
            <input
              type="text"
              id="cardioType"
              placeholder="e.g., Running, Cycling, Swimming"
            />
          </div>
          <div class="form-group">
            <label>Duration (minutes)</label>
            <input type="number" id="cardioDuration" placeholder="30" min="0" />
          </div>

          <div class="button-group">
            <button class="btn" onclick="saveWorkout()">Save Workout</button>
            <button class="btn btn-secondary" onclick="closeWorkoutModal()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-content">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirm-buttons">
          <button class="btn btn-danger" onclick="confirmAction(true)">
            Delete
          </button>
          <button class="btn btn-secondary" onclick="confirmAction(false)">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      let presets = [];
      let workouts = [];
      let currentPresetId = null;
      let currentWorkoutId = null;
      let presetExercises = [];
      let exercises = [];
      let confirmCallback = null;
      let timerInterval = null;
      let timerSeconds = 0;
      let timerRunning = false;
      let library = [];
      let currentExerciseId = null;

      function showConfirm(message, callback) {
        document.getElementById("confirmMessage").textContent = message;
        document.getElementById("confirmModal").classList.add("active");
        confirmCallback = callback;
      }

      function confirmAction(result) {
        document.getElementById("confirmModal").classList.remove("active");
        if (confirmCallback) {
          confirmCallback(result);
          confirmCallback = null;
        }
      }

      function init() {
        const savedPresets = localStorage.getItem("presets");
        if (savedPresets) {
          presets = JSON.parse(savedPresets);
        }
        const savedWorkouts = localStorage.getItem("workouts");
        if (savedWorkouts) {
          workouts = JSON.parse(savedWorkouts);
        }
        const savedLibrary = localStorage.getItem("library");
        if (savedLibrary) {
          library = JSON.parse(savedLibrary);
        }
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
          document.body.classList.add("light-theme");
        }
        renderPresets();
        renderWorkouts();
        renderLibrary();
      }

      function toggleTheme() {
        document.body.classList.toggle("light-theme");
        const isLight = document.body.classList.contains("light-theme");
        localStorage.setItem("theme", isLight ? "light" : "dark");
      }

      function saveToStorage() {
        localStorage.setItem("presets", JSON.stringify(presets));
        localStorage.setItem("workouts", JSON.stringify(workouts));
        localStorage.setItem("library", JSON.stringify(library));
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        if (tab === "presets") {
          document.querySelectorAll(".tab")[0].classList.add("active");
          document.getElementById("presetsTab").classList.add("active");
        } else if (tab === "workouts") {
          document.querySelectorAll(".tab")[1].classList.add("active");
          document.getElementById("workoutsTab").classList.add("active");
        } else if (tab === "library") {
          document.querySelectorAll(".tab")[2].classList.add("active");
          document.getElementById("libraryTab").classList.add("active");
        } else if (tab === "timer") {
          document.querySelectorAll(".tab")[3].classList.add("active");
          document.getElementById("timerTab").classList.add("active");
        }
      }

      // PRESET FUNCTIONS
      function showCreatePresetModal() {
        currentPresetId = null;
        presetExercises = [];
        document.getElementById("presetName").value = "";
        document.getElementById("presetModalTitle").textContent = "New Preset";
        renderPresetExercises();
        document.getElementById("presetModal").classList.add("active");
      }

      function showEditPresetModal(id) {
        const preset = presets.find((p) => p.id === id);
        if (!preset) return;

        currentPresetId = id;
        presetExercises = JSON.parse(JSON.stringify(preset.exercises));
        document.getElementById("presetName").value = preset.name;
        document.getElementById("presetModalTitle").textContent = "Edit Preset";
        renderPresetExercises();
        document.getElementById("presetModal").classList.add("active");
      }

      function closePresetModal() {
        document.getElementById("presetModal").classList.remove("active");
      }

      function toggleExerciseSelection(exerciseId) {
        const index = presetExercises.findIndex((e) => e.id === exerciseId);
        if (index > -1) {
          presetExercises.splice(index, 1);
        } else {
          const exercise = library.find((e) => e.id === exerciseId);
          if (exercise) {
            presetExercises.push({ id: exercise.id, name: exercise.name });
          }
        }
      }

      function renderPresetExercises() {
        const container = document.getElementById("presetExercisesList");
        if (library.length === 0) {
          container.innerHTML =
            '<p style="text-align:center; color:#666;">No exercises in library. Go to Library tab to add exercises.</p>';
          return;
        }

        const selectedIds = presetExercises.map((e) => e.id);

        container.innerHTML = library
          .map(
            (exercise) => `
                <div class="exercise-checkbox-item">
                    <input type="checkbox" 
                           id="ex-${exercise.id}" 
                           ${selectedIds.includes(exercise.id) ? "checked" : ""}
                           onchange="toggleExerciseSelection(${
                             exercise.id
                           }); renderPresetExercises()">
                    <label for="ex-${exercise.id}">${exercise.name}</label>
                </div>
            `
          )
          .join("");
      }

      function savePreset() {
        const name = document.getElementById("presetName").value.trim();

        if (!name) {
          showConfirm("Please enter a preset name", () => {});
          return;
        }

        if (presetExercises.length === 0) {
          showConfirm("Please select at least one exercise", () => {});
          return;
        }

        const preset = {
          id: currentPresetId || Date.now(),
          name,
          exercises: JSON.parse(JSON.stringify(presetExercises)),
        };

        if (currentPresetId) {
          const index = presets.findIndex((p) => p.id === currentPresetId);
          presets[index] = preset;
        } else {
          presets.push(preset);
        }

        saveToStorage();
        closePresetModal();
        renderPresets();
      }

      // LIBRARY FUNCTIONS
      function showCreateExerciseModal() {
        currentExerciseId = null;
        document.getElementById("exerciseName").value = "";
        document.getElementById("exerciseNotes").value = "";
        document.getElementById("exerciseModalTitle").textContent =
          "New Exercise";
        document.getElementById("exerciseModal").classList.add("active");
      }

      function showEditExerciseModal(id) {
        const exercise = library.find((e) => e.id === id);
        if (!exercise) return;

        currentExerciseId = id;
        document.getElementById("exerciseName").value = exercise.name;
        document.getElementById("exerciseNotes").value = exercise.notes || "";
        document.getElementById("exerciseModalTitle").textContent =
          "Edit Exercise";
        document.getElementById("exerciseModal").classList.add("active");
      }

      function closeExerciseModal() {
        document.getElementById("exerciseModal").classList.remove("active");
      }

      function saveExercise() {
        const name = document.getElementById("exerciseName").value.trim();
        const notes = document.getElementById("exerciseNotes").value.trim();

        if (!name) {
          showConfirm("Please enter an exercise name", () => {});
          return;
        }

        // Check for duplicate names (excluding current exercise if editing)
        const duplicate = library.find(
          (e) =>
            e.name.toLowerCase() === name.toLowerCase() &&
            e.id !== currentExerciseId
        );

        if (duplicate) {
          showConfirm("An exercise with this name already exists.", () => {});
          return;
        }

        const exercise = {
          id: currentExerciseId || Date.now(),
          name,
          notes: notes || "",
        };

        if (currentExerciseId) {
          const index = library.findIndex((e) => e.id === currentExerciseId);
          library[index] = exercise;

          // Update exercise name in all presets and workouts
          presets.forEach((preset) => {
            preset.exercises.forEach((ex) => {
              if (ex.id === currentExerciseId) {
                ex.name = name;
              }
            });
          });

          workouts.forEach((workout) => {
            workout.exercises.forEach((ex) => {
              if (ex.id === currentExerciseId) {
                ex.name = name;
              }
            });
          });
        } else {
          library.push(exercise);
        }

        saveToStorage();
        closeExerciseModal();
        renderLibrary();
        renderPresets();
        renderWorkouts();
      }

      function deleteExercise(id) {
        showConfirm(
          "Delete this exercise? It will be removed from all presets.",
          (result) => {
            if (result) {
              library = library.filter((e) => e.id !== id);

              // Remove from all presets
              presets.forEach((preset) => {
                preset.exercises = preset.exercises.filter((e) => e.id !== id);
              });

              saveToStorage();
              renderLibrary();
              renderPresets();
            }
          }
        );
      }

      function renderLibrary() {
        const container = document.getElementById("libraryList");

        if (library.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <h3>No exercises yet!</h3>
                        <p>Create your first exercise.</p>
                    </div>
                `;
          return;
        }

        const sortedLibrary = [...library].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        container.innerHTML = sortedLibrary
          .map(
            (exercise) => `
                <div class="workout-card" onclick="showEditExerciseModal(${
                  exercise.id
                })">
                    <h3>${exercise.name}</h3>
                    ${
                      exercise.notes
                        ? `<p class="exercise-notes">${exercise.notes}</p>`
                        : ""
                    }
                    <button class="btn btn-small btn-danger" 
                            style="margin-top: 12px;"
                            onclick="event.stopPropagation(); deleteExercise(${
                              exercise.id
                            })">
                        Delete
                    </button>
                </div>
            `
          )
          .join("");
      }

      function deletePreset(id) {
        showConfirm("Delete this preset?", (result) => {
          if (result) {
            presets = presets.filter((p) => p.id !== id);
            saveToStorage();
            renderPresets();
          }
        });
      }

      function renderPresets() {
        const container = document.getElementById("presetList");

        if (presets.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <h3>No presets yet!</h3>
                        <p>Create your first preset.</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = presets
          .map(
            (preset) => `
                <div class="workout-card" onclick="showEditPresetModal(${
                  preset.id
                })">
                    <h3>${preset.name}</h3>
                    <p>Exercises: ${preset.exercises.length}</p>
                    <p>${preset.exercises.map((e) => e.name).join(", ")}</p>
                    <button class="btn btn-small btn-danger" 
                            style="margin-top: 12px;"
                            onclick="event.stopPropagation(); deletePreset(${
                              preset.id
                            })">
                        Delete
                    </button>
                </div>
            `
          )
          .join("");
      }

      // WORKOUT FUNCTIONS
      function showTrackWorkoutModal() {
        currentWorkoutId = null;
        exercises = [];
        document.getElementById("workoutPreset").value = "";
        document.getElementById("workoutDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("cardioType").value = "";
        document.getElementById("cardioDuration").value = "";
        document.getElementById("workoutModalTitle").textContent =
          "Track Workout";
        document.getElementById("exercisesList").innerHTML = "";
        populatePresetDropdown();
        document.getElementById("workoutModal").classList.add("active");
      }

      function showEditWorkoutModal(id) {
        const workout = workouts.find((w) => w.id === id);
        if (!workout) return;

        currentWorkoutId = id;
        exercises = JSON.parse(JSON.stringify(workout.exercises));
        document.getElementById("workoutPreset").value = workout.presetId || "";
        document.getElementById("workoutDate").value = workout.date;
        document.getElementById("cardioType").value =
          workout.cardio?.type || "";
        document.getElementById("cardioDuration").value =
          workout.cardio?.duration || "";
        document.getElementById("workoutModalTitle").textContent =
          "Edit Workout";
        populatePresetDropdown();
        renderExercises();
        document.getElementById("workoutModal").classList.add("active");
      }

      function closeWorkoutModal() {
        document.getElementById("workoutModal").classList.remove("active");
      }

      function populatePresetDropdown() {
        const select = document.getElementById("workoutPreset");
        select.innerHTML =
          '<option value="">Choose a preset</option>' +
          presets
            .map((p) => `<option value="${p.id}">${p.name}</option>`)
            .join("");
      }

      function loadPresetExercises() {
        const presetId = parseInt(
          document.getElementById("workoutPreset").value
        );
        if (!presetId) {
          exercises = [];
          renderExercises();
          return;
        }

        const preset = presets.find((p) => p.id === presetId);
        if (!preset) return;

        exercises = preset.exercises.map((e) => ({
          id: Date.now() + Math.random(),
          name: e.name,
          sets: [{ type: "warmup", weight: 0, reps: 0 }],
        }));

        renderExercises();
      }

      function addSet(exerciseId) {
        const exercise = exercises.find((e) => e.id === exerciseId);
        if (exercise) {
          exercise.sets.push({ type: "working", weight: 0, reps: 0 });
          renderExercises();
        }
      }

      function removeSet(exerciseId, setIndex) {
        const exercise = exercises.find((e) => e.id === exerciseId);
        if (exercise && exercise.sets.length > 1) {
          exercise.sets.splice(setIndex, 1);
          renderExercises();
        }
      }

      function updateSetType(exerciseId, setIndex, type) {
        const exercise = exercises.find((e) => e.id === exerciseId);
        if (exercise) {
          exercise.sets[setIndex].type = type;
        }
      }

      function updateSetWeight(exerciseId, setIndex, weight) {
        const exercise = exercises.find((e) => e.id === exerciseId);
        if (exercise) {
          exercise.sets[setIndex].weight = parseFloat(weight) || 0;
        }
      }

      function updateSetReps(exerciseId, setIndex, reps) {
        const exercise = exercises.find((e) => e.id === exerciseId);
        if (exercise) {
          exercise.sets[setIndex].reps = parseInt(reps) || 0;
        }
      }

      function renderExercises() {
        const container = document.getElementById("exercisesList");
        if (exercises.length === 0) {
          container.innerHTML =
            '<p style="text-align:center; color:#666;">Select a preset to load exercises</p>';
          return;
        }

        container.innerHTML = exercises
          .map(
            (exercise) => `
                <div class="exercise-item">
                    <div class="exercise-header">
                        <h4>${exercise.name}</h4>
                    </div>
                    
                    <div class="sets-container">
                        <div class="set-labels">
                            <div>Set</div>
                            <div>Type</div>
                            <div>Weight</div>
                            <div>Reps</div>
                        </div>
                        ${exercise.sets
                          .map(
                            (set, idx) => `
                            <div class="set-row">
                                <div class="set-number">${idx + 1}</div>
                                <select onchange="updateSetType(${
                                  exercise.id
                                }, ${idx}, this.value)">
                                    <option value="warmup" ${
                                      set.type === "warmup" ? "selected" : ""
                                    }>Warmup</option>
                                    <option value="working" ${
                                      set.type === "working" ? "selected" : ""
                                    }>Working</option>
                                </select>
                                <input type="number" value="${set.weight}" 
                                       onchange="updateSetWeight(${
                                         exercise.id
                                       }, ${idx}, this.value)"
                                       placeholder="kg">
                                <input type="number" value="${set.reps}" 
                                       onchange="updateSetReps(${
                                         exercise.id
                                       }, ${idx}, this.value)"
                                       placeholder="0">
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    
                    <div class="button-row" style="margin-top: 12px;">
                        <button class="btn btn-small btn-secondary" onclick="addSet(${
                          exercise.id
                        })">Add Set</button>
                        ${
                          exercise.sets.length > 1
                            ? `<button class="btn btn-small btn-danger" onclick="removeSet(${
                                exercise.id
                              }, ${
                                exercise.sets.length - 1
                              })">Remove Set</button>`
                            : ""
                        }
                    </div>
                </div>
            `
          )
          .join("");
      }

      function saveWorkout() {
        const presetId = parseInt(
          document.getElementById("workoutPreset").value
        );
        const date = document.getElementById("workoutDate").value;
        const cardioType = document.getElementById("cardioType").value.trim();
        const cardioDuration =
          parseInt(document.getElementById("cardioDuration").value) || 0;

        if (!presetId) {
          showConfirm("Please select a preset", () => {});
          return;
        }

        if (exercises.length === 0) {
          showConfirm("No exercises to track", () => {});
          return;
        }

        const preset = presets.find((p) => p.id === presetId);
        const workout = {
          id: currentWorkoutId || Date.now(),
          presetId,
          presetName: preset.name,
          date,
          exercises: JSON.parse(JSON.stringify(exercises)),
        };

        if (cardioType && cardioDuration > 0) {
          workout.cardio = {
            type: cardioType,
            duration: cardioDuration,
          };
        }

        if (currentWorkoutId) {
          const index = workouts.findIndex((w) => w.id === currentWorkoutId);
          workouts[index] = workout;
        } else {
          workouts.push(workout);
        }

        saveToStorage();
        closeWorkoutModal();
        renderWorkouts();
      }

      function deleteWorkout(id) {
        showConfirm("Delete this workout?", (result) => {
          if (result) {
            workouts = workouts.filter((w) => w.id !== id);
            saveToStorage();
            renderWorkouts();
          }
        });
      }

      function renderWorkouts() {
        const container = document.getElementById("workoutList");

        if (workouts.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts yet!</h3>
                        <p>Track your first workout.</p>
                    </div>
                `;
          return;
        }

        const sorted = [...workouts].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );

        container.innerHTML = sorted
          .map(
            (workout) => `
                <div class="workout-card" onclick="showEditWorkoutModal(${
                  workout.id
                })">
                    <h3>${workout.presetName}</h3>
                    <p>Date: ${new Date(workout.date).toLocaleDateString()}</p>
                    <p>Exercises: ${workout.exercises.length}</p>
                    <p>Total Sets: ${workout.exercises.reduce(
                      (sum, ex) => sum + ex.sets.length,
                      0
                    )}</p>
                    ${
                      workout.cardio
                        ? `<p>Cardio: ${workout.cardio.type} - ${workout.cardio.duration} min</p>`
                        : ""
                    }
                    <button class="btn btn-small btn-danger" 
                            style="margin-top: 12px;"
                            onclick="event.stopPropagation(); deleteWorkout(${
                              workout.id
                            })">
                        Delete
                    </button>
                </div>
            `
          )
          .join("");
      }

      // EXPORT/IMPORT FUNCTIONS
      function exportData() {
        const data = {
          presets,
          workouts,
          library,
          exportDate: new Date().toISOString(),
        };

        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `workout-tracker-${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);

            if (!data.presets || !data.workouts) {
              showConfirm("Invalid file format", () => {});
              return;
            }

            showConfirm(
              "Import data? This will replace your current data.",
              (result) => {
                if (result) {
                  presets = data.presets;
                  workouts = data.workouts;
                  library = data.library || [];
                  saveToStorage();
                  renderPresets();
                  renderWorkouts();
                  renderLibrary();
                  showConfirm("Data imported successfully", () => {});
                }
              }
            );
          } catch (error) {
            showConfirm(
              "Error reading file. Please ensure it is a valid JSON file.",
              () => {}
            );
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      }

      // TIMER FUNCTIONS
      function setTimer(seconds) {
        timerSeconds = seconds;
        updateTimerDisplay();
        if (timerRunning) {
          pauseTimer();
        }
      }

      function setCustomTimer() {
        const customSeconds = parseInt(
          document.getElementById("customTime").value
        );
        if (customSeconds && customSeconds > 0) {
          setTimer(customSeconds);
          document.getElementById("customTime").value = "";
        }
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById(
          "timerDisplay"
        ).textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
      }

      function startTimer() {
        if (timerSeconds === 0) return;

        timerRunning = true;
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("pauseBtn").style.display = "inline-block";

        timerInterval = setInterval(() => {
          timerSeconds--;
          updateTimerDisplay();

          if (timerSeconds === 0) {
            pauseTimer();
            if ("vibrate" in navigator) {
              navigator.vibrate([200, 100, 200]);
            }
            alert("Time's up!");
          }
        }, 1000);
      }

      function pauseTimer() {
        timerRunning = false;
        clearInterval(timerInterval);
        document.getElementById("startBtn").style.display = "inline-block";
        document.getElementById("pauseBtn").style.display = "none";
      }

      function resetTimer() {
        pauseTimer();
        timerSeconds = 0;
        updateTimerDisplay();
      }

      init();
    </script>
  </body>
</html>
